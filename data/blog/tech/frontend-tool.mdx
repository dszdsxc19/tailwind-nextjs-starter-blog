---
title: 'Commit Better Code with Husky, Prettier, commitlint and Lint-Staged'
date: 2023-11-05T22:15:11+08:00
draft: false
tags: ['npm', 'ä»£ç ç¾åŒ–', 'å‰ç«¯']
---

## å‰è¨€
å¦‚æœä½ é€›Githubçš„è¯ï¼Œå°±ä¼šå‘ç°å¾ˆå¤šé¡¹ç›®æ ¹ç›®å½•é™¤äº†`.github`è¿˜æœ‰ä¸ª`.husky`æ–‡ä»¶å¤¹ï¼Œæˆ‘ä¸€ç›´å¥½å¥‡è¿™ä¸ªæ–‡ä»¶å¤¹çš„ä½œç”¨ã€‚ä»Šå¤©æ­£å¥½åˆ›å»ºäº†ä¸€ä¸ªæ–°é¡¹ç›®ï¼Œå€Ÿæ­¤æœºä¼šä¸€æ¢ç©¶ç«Ÿã€‚

### é¡¹ç›®åœ°å€
- [husky](https://github.com/typicode/husky)
- [prettier](https://github.com/prettier/prettier)
- [lint-staged](https://github.com/lint-staged/lint-staged)
- [eslint](https://github.com/eslint/eslint)
- [commitlint](https://github.com/conventional-changelog/commitlint)

## äº†è§£Git Hooks
Git Hooks æ˜¯åœ¨ Git æ‰§è¡Œç‰¹å®šäº‹ä»¶ï¼ˆå¦‚commitã€pushã€receiveç­‰ï¼‰æ—¶è§¦å‘è¿è¡Œçš„**è„šæœ¬**ï¼ˆä¹Ÿå°±æ˜¯Shellï¼ŒPythonç­‰è¯­è¨€éƒ½å¯ä»¥ï¼‰ï¼Œç±»ä¼¼äºâ€œé’©å­å‡½æ•°â€ã€‚è·Ÿé’©å­å‡½æ•°ä¸€æ ·ï¼ŒGit Hookså¯ä»¥èµ·åˆ°ä¸€ä¸ªæ‰¿ä¸Šå¯ä¸‹çš„ä½œç”¨ã€‚

Git Hooksæ˜¯Gitæä¾›çš„ç‰¹æ€§ã€‚é’©å­éƒ½è¢«å­˜å‚¨åœ¨ Git ç›®å½•ä¸‹çš„ hooks å­ç›®å½•ä¸­ã€‚ ä¹Ÿå³ç»å¤§éƒ¨åˆ†é¡¹ç›®ä¸­çš„ .git/hooks ã€‚ å½“ä½ ç”¨ git init åˆå§‹åŒ–ä¸€ä¸ªæ–°ç‰ˆæœ¬åº“æ—¶ï¼ŒGit é»˜è®¤ä¼šåœ¨è¿™ä¸ªç›®å½•ä¸­æ”¾ç½®ä¸€äº›ç¤ºä¾‹è„šæœ¬ã€‚é’©å­åˆå¯ä»¥åˆ†ç±»ä¸ºå®¢æˆ·ç«¯é’©å­å’ŒæœåŠ¡å™¨ç«¯é’©å­ã€‚å®¢æˆ·ç«¯é’©å­åˆ†ä¸ºå¾ˆå¤šç§ã€‚ ä¸‹é¢æŠŠå®ƒä»¬åˆ†ä¸ºï¼šæäº¤å·¥ä½œæµé’©å­ã€ç”µå­é‚®ä»¶å·¥ä½œæµé’©å­å’Œå…¶å®ƒé’©å­ã€‚å¦‚æœæƒ³äº†è§£æ›´å¤šå…³äºGit Hooksçš„ç»†èŠ‚ï¼Œè¯·å‚è€ƒ[Gitå®˜æ–¹æ–‡æ¡£ï¼ˆGit é’©å­ï¼‰](https://git-scm.com/book/zh/v2/è‡ªå®šä¹‰-Git-Git-é’©å­)

### Git Hookså­˜åœ¨çš„é—®é¢˜
ç”±äºGit Hooksé»˜è®¤æ˜¯å­˜åœ¨`.git`ç›®å½•ä¸‹çš„ï¼Œæ— æ³•è¿›è¡Œç‰ˆæœ¬æ§åˆ¶ã€‚å¥½åœ¨Gitæ–°ç‰ˆæœ¬ä¸­`core.hooksPath`çš„å‡ºç°å¯ä»¥ä½¿Hookså­˜æ”¾çš„è·¯å¾„æŒ‡å‘è‡ªå®šä¹‰çš„ç›®å½•ã€‚

## husky
ä¸ºä»€ä¹ˆéœ€è¦åœ¨git hooksä¸Šå†å¤šhuskyè¿™ä¸ªä¸Šå±‚å»ºç­‘å‘¢ï¼Ÿç®€è€Œè¨€ä¹‹ï¼Œ**å®ƒèƒ½å¤Ÿç®€åŒ–åˆ›å»ºå’Œä¿®æ”¹Githooksçš„æ“ä½œ**ã€‚

### å®‰è£…husky
æ ¹æ®[huskyå®˜æ–¹æ–‡æ¡£](https://typicode.github.io/husky/getting-started.html)ï¼Œ
```sh
npx husky-init && npm install
```
å®ƒä¼šï¼š
1. æ·»åŠ `prepare`è„šæœ¬åˆ°`package.json`
2. åˆ›å»ºä¸€ä¸ªæ¨¡æ¿`pre-commit`é’©å­
3. é…ç½®Git hooksè·¯å¾„åˆ°`.husky`

### è‡ªå®šä¹‰é’©å­
ä»¥ä¸‹å‘½ä»¤ä¼šåˆ›å»ºä¸€ä¸ª`pre-commit`git hookï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯æ¬¡commitä¹‹å‰éƒ½ä¼šæ‰§è¡Œ`npm test`,å¦‚æœæ‰§è¡Œå¤±è´¥å‘¢ï¼Œå°±ä¸ä¼š`commit`æˆåŠŸã€‚
```sh
npx husky add .husky/pre-commit "npm test"
```
ï¼ˆå¦‚æœä¸æ¸…æ¥šnpmå’Œnpxçš„åŒºåˆ«ï¼Œè¯·å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼š[npm å’Œ npx æ˜¯ä»€ä¹ˆ](../npx_vs_npm)ï¼‰
## prettier
> Prettier is an opinionated code formatter. It enforces a consistent style by parsing your code and re-printing it with its own rules that take the maximum line length into account, wrapping code when necessary.

ç®€è€Œè¨€ä¹‹ï¼ŒPrettier æ˜¯ä¸€ä¸ªä»£ç ç¾åŒ–å·¥å…·ã€‚æ”¯æŒJavaScript Â· TypeScript Â· Flow Â· JSX Â· JSON Â· CSS Â· SCSS Â· Less Â· HTML Â· Vue Â· Angular Â· GraphQL Â· Markdown Â· YAMLç­‰è¯­è¨€ã€‚

### å®‰è£…prettier
åŒæ ·ï¼Œå‚è€ƒè‡ª[å®˜æ–¹æ–‡æ¡£](https://prettier.io/docs/en/install)ã€‚

```sh
npm install --save-dev --save-exact prettier
```
ç„¶åæ‰§è¡Œä¸‹åˆ—å‘½ä»¤ä¼šåœ¨æ ¹ç›®å½•æ–°å»ºä¸€ä¸ªç©ºçš„`prettier`é…ç½®æ–‡ä»¶ã€‚
```sh
node --eval "fs.writeFileSync('.prettierrc','{}\n')"
```

### CLIä½¿ç”¨
ä¸»è¦æœ‰ä¸¤ä¸ªæ“ä½œï¼š
- checkï¼ˆæ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç¬¦åˆä»£ç é£æ ¼ï¼Œä½†ä¸æ‰§è¡Œæ ¼å¼åŒ–ï¼‰
- writeï¼ˆæ ¼å¼åŒ–æ–‡ä»¶ï¼‰

#### check
è¿™é‡Œçš„`.`æ˜¯æŒ‡å½“å‰ç›®å½•ï¼Œå¯ä»¥è‡ªå·±æŒ‡å®šæƒ³è¦æ ¼å¼åŒ–çš„ç›®å½•ã€‚
```sh
npx prettier . --check
```

#### write
è¿™é‡Œçš„`.`æ˜¯æŒ‡å½“å‰ç›®å½•ï¼Œå¯ä»¥è‡ªå·±æŒ‡å®šæƒ³è¦æ ¼å¼åŒ–çš„ç›®å½•ã€‚
```sh
npx prettier . --write
```

### ä¸ç¼–è¾‘å™¨é›†æˆ
é™¤äº†æ‰§è¡Œå‘½ä»¤æ ¼å¼åŒ–ä¹‹å¤–ï¼Œæ›´å¸¸ç”¨çš„æ˜¯åœ¨ç¼–è¾‘å™¨ä¸­æ‰§è¡Œæ“ä½œï¼Œæ¯”å¦‚ä¿å­˜æ–‡ä»¶æ—¶è§¦å‘æ ¼å¼åŒ–ã€‚æœ¬æ–‡ä¸»è¦è®°å½•ä¸Huskyçš„è”åŠ¨ï¼Œä¸æ‰“ç®—æ·±ç©¶è¿™éƒ¨åˆ†ï¼Œå…·ä½“å‚è€ƒ[Editor Integration](https://prettier.io/docs/en/editors)ã€‚

### eslint-config-prettier
æ³¨æ„âš ï¸ï¼šå¦‚æœé¡¹ç›®ä¸­åŒæ—¶ä½¿ç”¨äº†eslintå’Œprettierï¼Œé‚£ä¹ˆè¿˜éœ€è¦[eslint-config-prettier](https://github.com/prettier/eslint-config-prettier)ï¼Œæ¥é¿å…eslintå’Œprettieré…ç½®çš„å†²çªã€‚å®ƒä¼šå…³é—­æ‰€æœ‰éå¿…è¦æˆ–è€…ä¼šå¯¼è‡´ä¸prettierå†²çªçš„ESLintè§„åˆ™ã€‚

#### Prettier vs. Linters
> Linters have two categories of rules:
> 
> **Formatting rules**: eg: max-len, no-mixed-spaces-and-tabs, keyword-spacing, comma-styleâ€¦
> 
> Prettier alleviates the need for this whole category of rules! Prettier is going to reprint the entire program from scratch in a consistent way, so itâ€™s not possible for the programmer to make a mistake there anymore :)
> 
> **Code-quality rules**: eg no-unused-vars, no-extra-bind, no-implicit-globals, prefer-promise-reject-errorsâ€¦
> 
> Prettier does nothing to help with those kind of rules. They are also the most important ones provided by linters as they are likely to catch real bugs with your code!
> 
> In other words, use Prettier for formatting and linters for catching bugs!

æ€»å„¿é¢œå€¼å°±æ˜¯ï¼Œä½¿ç”¨`Prettier`æ¥æ ¼å¼åŒ–ä»£ç ï¼Œ`linters`æ¥æŠ‘åˆ¶bugã€‚

lintersçš„ä¸€ä¸ªä»£è¡¨å°±æ˜¯eslintï¼šeslintæ˜¯ä¸€ä¸ªæŒ‰ç…§è§„åˆ™æ‰§è¡Œä»£ç æ£€æŸ¥çš„å·¥å…·ï¼Œå®ƒå¯ä»¥åœ¨ç¼–ç é˜¶æ®µè¿›è¡Œé™æ€åˆ†æï¼Œç»™å‡ºæ£€æŸ¥æŠ¥å‘Šã€‚æ­é…ä¸€äº›æ’ä»¶ï¼Œå¯ä»¥æå‰æš´éœ²é—®é¢˜ï¼Œç»™å‡ºæç¤ºï¼Œå¹¶è¿›è¡Œä¿®å¤ï¼Œå¤§å¤§å‡å°‘æ‰§è¡Œè¿‡ç¨‹ä¸­çš„bugã€‚

## lint-staged
lint-stagedæ˜¯ä¸€ä¸ªåœ¨**gitæš‚å­˜æ–‡ä»¶(staged)**ä¸Šè¿è¡Œlintersçš„å·¥å…·ã€‚
å®˜æ–¹çš„åŸæ–‡æ˜¯ï¼š
> Run linters against staged git files and don't let ğŸ’© slip into your code base!

å®ƒçš„å¥½å¤„æ˜¯ï¼š
> But running a lint process on a whole project is slow, and linting results can be irrelevant. Ultimately you only want to lint files that will be committed.

### å®‰è£… lint-staged
```sh
npm install --save-dev lint-staged
```

ä½¿ç”¨éœ€è¦æ­é…`husky`å’Œ`Prettier`ç­‰å·¥å…·ï¼Œç›´æ¥çœ‹[æœ€ä½³å®è·µéƒ¨åˆ†]()ã€‚

## commitlint
ä»ä¸Šæ–‡å°±å¯ä»¥å¾—çŸ¥ï¼Œlintæ˜¯ä¸€ç±»æŒ‰ç…§è§„åˆ™æ‰§è¡Œæ£€æŸ¥çš„å·¥å…·ï¼Œcommitlintå°±æ˜¯ä¸€ä¸ª`git commit`æ ¡éªŒçº¦æŸå·¥å…·ã€‚å®ƒè¦æ±‚æˆ‘ä»¬çš„æäº¤è®°å½•ç¬¦åˆ[conventional-commits](https://github.com/conventional-commits/conventionalcommits.org)è§„èŒƒã€‚

### å®‰è£…
```sh
npm install --save-dev @commitlint/{config-conventional,cli}
echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
```
ç„¶ååœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®è¯¦ç»†çš„è§„åˆ™ã€‚

### è§„åˆ™
è¯¦ç»†è§„åˆ™å‚è€ƒï¼š[å®˜æ–¹æ–‡æ¡£](https://commitlint.js.org/#/reference-rules)ã€‚

#### angularçš„æ¡ˆä¾‹
ä¸åŒçš„ç¼–ç¨‹è¯­è¨€è¿˜è´´å¿ƒåœ°ç»™å‡ºäº†ä¸åŒçš„æäº¤è§„èŒƒï¼Œä¸€èˆ¬æˆ‘åªéœ€è¦å§extendsçš„ç±»å‹ä¿®æ”¹ä¸€ä¸‹å³å¯ã€‚

```sh
npm install --save-dev @commitlint/config-angular @commitlint/cli
echo "module.exports = {extends: ['@commitlint/config-angular']};" > commitlint.config.js
```

### ä¸huskyçš„ç»“åˆ
è¦åœ¨æäº¤ä¹‹å‰ç”Ÿæ•ˆï¼Œéœ€è¦æ·»åŠ å¦‚ä¸‹é’©å­ï¼š
```sh
npx husky add .husky/commit-msg  'npx --no -- commitlint --edit ${1}'
```

## æœ€ä½³å®è·µ
å‚è€ƒè‡ªï¼š[Prettier #Git hooks](https://prettier.io/docs/en/install#git-hooks)

```sh
# prettier
npm install --save-dev --save-exact prettier
node --eval "fs.writeFileSync('.prettierrc','{}\n')"
# husky & lint-staged
npm install --save-dev husky lint-staged
npx husky install
npm pkg set scripts.prepare="husky install"
npx husky add .husky/pre-commit "npx lint-staged"
# commitlint
npm install --save-dev @commitlint/{config-conventional,cli}
echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
npx husky add .husky/commit-msg  'npx --no -- commitlint --edit ${1}'
```
ç„¶ååœ¨`package.json`ä¸­åŠ å…¥ï¼š
```json
{
  "scripts": {
    ...
  },
  "lint-staged": {
    "**/*": "prettier --write --ignore-unknown"
  }
}
```
è¿™æ ·å°±ä¼šåœ¨æ¯æ¬¡æäº¤ä»£ç ä¹‹å‰å¯¹æ‰€æœ‰æ”¯æŒçš„æ–‡ä»¶ç±»å‹æ‰§è¡Œæ ¼å¼åŒ–æ“ä½œã€‚

### é™åˆ¶lint-stagedçš„èŒƒå›´
```json
{
  "scripts": {
    ...
  },
  "lint-staged": {
    "src/**/!(*.min).js": [
      "prettier --check",
    ],
    "src/**/*.{ts,vue}": [
      "prettier --write",
    ],
    "src/**/*.{ts,js,vue,html,css,scss,sass,stylus}": [
      "prettier --write"
    ]
  },
}
```
è¿™æ ·å°±ä¼šå¯¹ä¸åŒçš„æ–‡ä»¶å¤¹ä¸‹é¢çš„ä¸åŒæ–‡ä»¶ç±»å‹çš„æ–‡ä»¶æ‰§è¡Œä¸åŒçš„è„šæœ¬ã€‚

